---
title: 9. Upgrade
---

**Automation tests**

|  **#** | **Test name** | **Description** | **Tags** |
| --- | --- | --- | --- |
| 1   | test\_upgrade | Test Longhorn upgrade<br><br>1.  Find the upgrade image tag<br>2.  Create a volume, generate and write `data` into the volume.<br>3.  Keep the volume attached, then upgrade Longhorn system.<br>4.  Detach the volume.<br>5.  Upgrade the volume to the updated engine image.<br>6.  Attach the volume and verify `data` | Upgrade |
| 2   | test\_engine\_image | Test Engine Image deployment<br><br>1.  List Engine Images and validate basic properities.<br>2.  Try deleting default engine image and it should fail.<br>3.  Try creating a duplicate engine image as default and it should fail<br>4.  Get upgrade test image for the same versions<br>5.  Test if the upgrade test image can be deployed and deleted correctly | Upgrade: Engine |
| 3   | test\_engine\_image\_incompatible | Test incompatible engine images<br><br>1.  Deploy incompatible engine images<br>2.  Make sure their state are `incompatible` once deployed. | Upgrade: Engine |
| 4   | test\_engine\_live\_upgrade | Test engine live upgrade<br><br>1.  Deploy a compatible new engine image<br>2.  Create a volume (with the old default engine image)<br>3.  Attach the volume and write `data` to it<br>4.  Upgrade the volume when it's attached, to the new engine image<br>5.  Wait until the upgrade completed, verify the volume engine image changed<br>6.  Verify the reference count of the new engine image changed<br>7.  Verify all engine and replicas' engine image changed<br>8.  Check volume `data`<br>9.  Detach the volume. Check engine and replicas's engine image again.<br>10.  Attach the volume.<br>11.  Check engine/replica engine image. Check data after reattach.<br>12.  Live upgrade to the original engine image<br>13.  Check old and new engine image reference count (new 0, old 1)<br>14.  Verify all the engine and replica images should be the old image<br>15.  Check volume data<br>16.  Detach the volume. Make sure engine and replica images are old image | Upgrade: Engine |
| 5   | test\_engine\_live\_upgrade\_rollback | Test engine live upgrade rollback<br><br>1.  Deploy `wrong_engine_upgrade_image` compatible upgrade engine image<br>    1.  It's not functional but compatible per metadata.<br>        <br>2.  Create a volume with default engine image<br>3.  Attach it and write `data` into it.<br>4.  Live upgrade to the `wrong_engine_upgrade_image`<br>5.  Try to wait for the engine upgrade to complete. Expect it to timeout.<br>6.  Rollback by upgrading to the `original_engine_image`<br>7.  Make sure the rollback succeed and volume/engine engines are rolled back<br>8.  Check the volume `data`.<br>9.  Live upgrade to the `wrong_engine_upgrade_image` again.<br>10.  Live upgrade will still fail.<br>11.  Detach the volume.<br>12.  The engine image for the volume will now be upgraded (since the `wrong` image is still compatible)<br>13.  Upgrade to the `original_engine_image` when detached<br>14.  Attach the volume and check states and `data`. | Upgrade: Engine |
| 6   | test\_engine\_offline\_upgrade | Test engine offline upgrade<br><br>1.  Get a compatible engine image with the default engine image, and deploy<br>2.  Create a volume using the default engine image<br>3.  Attach the volume and write `data` into it<br>4.  Detach the volume and upgrade the volume engine to the new engine image<br>5.  Make sure the new engine image reference count has increased to 1<br>6.  Make sure we cannot delete the new engine image now (due to reference)<br>7.  Attach the volume and verify it's using the new image<br>8.  Verify the data. And verify engine and replicas' engine image changed<br>9.  Detach the volume<br>10.  Upgrade to the old engine image<br>11.  Verify the volume's engine image has been upgraded<br>12.  Attach the volume and verify the `data` | Upgrade: Engine |

**Additional Test cases**

| **#**| **Test name** | **Description** |
| --- | --- | --- |
| 1   | Higher version of Longhorn engine and lower version of volume | Test Longhorn upgrade<br><br>1.  Create a volume, generate and write `data` into the volume.<br>2.  Keep the volume attached, then upgrade Longhorn system.<br>3.  Write data in volume.<br>4.  Take snapshot#1. Compute the checksum#1<br>5.  Write data to volume. Compute the checksum#2<br>6.  Take backup<br>7.  Revert to snapshot#1<br>8.  Restore the backup. |
| 2   | Restore the backup taken with older engine version | 1.  Create a volume, attach to a pod and write data into the volume. Compute md5sum of data<br>2.  Take a backup.<br>3.  Upgrade engine.<br>4.  Make the upgraded engine as default.<br>5.  Restore the backup, verify the checksum |