<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.0">
<title>tests.test_recurring_job API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>tests.test_recurring_job</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="tests.test_recurring_job.add_recurring_job_source_to_pvc"><code class="name flex">
<span>def <span class="ident">add_recurring_job_source_to_pvc</span></span>(<span>name, core_api)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="tests.test_recurring_job.recurring_job_labels_test"><code class="name flex">
<span>def <span class="ident">recurring_job_labels_test</span></span>(<span>client, labels, volume_name, size='16777216', backing_image='')</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="tests.test_recurring_job.remove_recurring_job_source_to_pvc"><code class="name flex">
<span>def <span class="ident">remove_recurring_job_source_to_pvc</span></span>(<span>name, core_api)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job"><code class="name flex">
<span>def <span class="ident">test_recurring_job</span></span>(<span>set_random_backupstore, client, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario : test recurring job (S3/NFS)</p>
<p>Given <code>snapshot1</code> recurring job created and cron at 1 min and retain 2.
<code>backup1</code>
recurring job created and cron at 2 min and retain 1.
<code>backup2</code>
recurring job created and cron at 1 min and retain 2.
And a volume created and attached.</p>
<p>When label volume with recurring job <code>snapshot1</code>.
label volume with recurring job <code>backup1</code>.
And wait until the 20th second since the beginning of an even minute.
And write data to volume.
wait for 2 minutes.
And write data to volume.
wait for 2 minutes.
Then volume have 4 snapshots.
(2 from <code>snapshot1</code>, 1 from <code>backup1</code>, 1 from <code>volume-head</code>)</p>
<p>When label volume with recurring job <code>backup2</code>
And write data to volume.
wait for 2 minutes.
And write data to volume.
wait for 2 minutes.
Then volume have 5 snapshots.
(2 from <code>snapshot1</code>, 1 from <code>backup1</code>, 1 from <code>backup2</code>,
1 from <code>volume-head</code>)</p>
<p>When wait until backups complete.
Then <code>backup1</code> completed 1 backups.
<code>backup2</code> completed 2 backups.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_backup"><code class="name flex">
<span>def <span class="ident">test_recurring_job_backup</span></span>(<span>set_random_backupstore, client, batch_v1_api)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job backup (S3/NFS)</p>
<p>Given volume <code>test-job-1</code> created, attached, and healthy.
volume <code>test-job-2</code> created, attached, and healthy.</p>
<p>When create a recurring job with <code>default</code> in groups.
Then should have 1 cron job.</p>
<p>When write some data to volume <code>test-job-1</code>.
write some data to volume <code>test-job-2</code>.
And wait for <code>backup1</code> cron job scheduled time.
Then volume <code>test-job-1</code> should have 1 backups.
volume <code>test-job-2</code> should have 1 backups.</p>
<p>When write some data to volume <code>test-job-1</code>.
write some data to volume <code>test-job-2</code>.
And wait for <code>backup1</code> cron job scheduled time.
Then volume <code>test-job-1</code> should have 2 backups.
volume <code>test-job-2</code> should have 2 backups.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_default"><code class="name flex">
<span>def <span class="ident">test_recurring_job_default</span></span>(<span>client, batch_v1_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job set with default in groups</p>
<p>Given 1 volume created, attached, and healthy.</p>
<h1 id="setting-recurring-job-in-volume-label-should-not-remove-the-defaults">Setting recurring job in volume label should not remove the defaults.</h1>
<p>When set <code>snapshot</code> recurring job in volume label.
Then should contain <code>default</code>
job-group in volume labels.
should contain <code>snapshot</code> job
in volume labels.</p>
<h1 id="should-be-able-to-remove-the-default-label">Should be able to remove the default label.</h1>
<p>When delete recurring job-group <code>default</code> in volume label.
Then volume should have
<code>snapshot</code>
job
in job label.
volume should not have <code>default</code>
group in job label.</p>
<h1 id="remove-all-volume-recurring-job-labels-should-bring-in-default">Remove all volume recurring job labels should bring in default</h1>
<p>When delete all recurring jobs in volume label.
Then volume should not have <code>snapshot</code>
job
in job label.
volume should
have <code>default</code>
group in job label.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_delete"><code class="name flex">
<span>def <span class="ident">test_recurring_job_delete</span></span>(<span>client, batch_v1_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test delete recurring job</p>
<p>Given 1 volume created, attached, and healthy.</p>
<p>When create <code>snapshot1</code> recurring job with <code>default, group-1</code> in groups.
create <code>snapshot2</code> recurring job with <code>default</code>
in groups..
create <code>snapshot3</code> recurring job with <code>in groups.
create &lt;code&gt;backup1&lt;/code&gt;
recurring job with `default, group-1` in groups.
create &lt;code&gt;backup2&lt;/code&gt;
recurring job with &lt;code&gt;default&lt;/code&gt;
in groups.
create &lt;code&gt;backup3&lt;/code&gt;
recurring job with</code>
in groups.
Then default <code>snapshot1</code> cron job should exist.
default <code>snapshot2</code> cron job should exist.
<code>snapshot3</code> cron job should exist.
default <code>backup1</code>
cron job should exist.
default <code>backup2</code>
cron job should exist.
<code>backup3</code>
cron job should exist.</p>
<h1 id="delete-snapshot2-recurring-job-should-delete-the-cron-job">Delete <code>snapshot2</code> recurring job should delete the cron job</h1>
<p>When delete <code>snapshot-2</code> recurring job.
Then default <code>snapshot1</code> cron job should
exist.
default <code>snapshot2</code> cron job should not exist.
<code>snapshot3</code> cron job should
exist.
default <code>backup1</code>
cron job should
exist.
default <code>backup2</code>
cron job should
exist.
<code>backup3</code>
cron job should
exist.</p>
<h1 id="delete-multiple-recurring-jobs-should-reflect-on-the-cron-jobs">Delete multiple recurring jobs should reflect on the cron jobs.</h1>
<p>When delete <code>backup-1</code> recurring job.
delete <code>backup-2</code> recurring job.
delete <code>backup-3</code> recurring job.
Then default <code>snapshot1</code> cron job should
exist.
default <code>snapshot2</code> cron job should not exist.
<code>snapshot3</code> cron job should
exist.
default <code>backup1</code>
cron job should not exist.
default <code>backup2</code>
cron job should not exist.
<code>backup3</code>
cron job should not exist.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_delete_should_remove_volume_label"><code class="name flex">
<span>def <span class="ident">test_recurring_job_delete_should_remove_volume_label</span></span>(<span>client, batch_v1_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test delete recurring job should remove volume labels</p>
<p>Given 1 volume created.
And
create <code>snapshot1</code> recurring job.
create <code>backup1</code>
recurring job.
And
<code>snapshot1</code> job applied to the volume.
<code>backup1</code>
job applied to the volume.
And
<code>snapshot1</code> job exist in volume recurring job label.
<code>backup1</code>
job exist in volume recurring job label.</p>
<p>When delete <code>snapshot1</code> recurring job.
Then <code>snapshot1</code> job not exist in volume recurring job label.
<code>backup1</code>
job
exist in volume recurring job label.</p>
<p>When delete <code>backup1</code> recurring job.
Then <code>snapshot1</code> job not exist in volume recurring job label.
<code>backup1</code>
job not exist in volume recurring job label.</p>
<p>Given create <code>snapshot1</code> recurring job with <code>group-1</code> in groups.
And
create <code>snapshot2</code> recurring job with <code>group-1</code> in groups.
And
create <code>backup1</code>
recurring job with <code>group-1</code> in groups.
And
create <code>backup2</code>
recurring job with <code>default</code> in groups.
// The default job-group automatically applies to the volumes
// with no recurring job. We want to keep the test focused on the
// behavior so removing the default job-group assignment first.
And
remove volume recurring job label <code>default</code> job-group.
And
<code>group-1</code> job-group applied to the volume.
And
<code>group-1</code> job-group
exist in volume recurring job label.
<code>default</code> job-group not exist in volume recurring job label.</p>
<p>When delete <code>snapshot1</code> recurring job.
Then <code>group-1</code> job-group exist in volume recurring job label.</p>
<p>When delete <code>snapshot2</code> recurring job.
Then <code>group-1</code> job-group exist in volume recurring job label.</p>
<p>When delete <code>back1</code> recurring job.
Then <code>group-1</code> job-group not exist in volume recurring job label.
And
<code>default</code> job-group
exist in volume recurring job label.</p>
<p>When delete <code>back2</code> recurring job.
Then should not remove <code>default</code> job-group in volume.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_detached_volume"><code class="name flex">
<span>def <span class="ident">test_recurring_job_detached_volume</span></span>(<span>client, batch_v1_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job while volume is detached</p>
<p>Given a volume created, and attached.
And write some data to the volume.
And detach the volume.</p>
<p>When create a recurring job running at 1 minute interval,
and with <code>default</code> in groups,
and with <code>retain</code> set to <code>2</code>.
And 1 cron job should be created.
And wait for 2 minutes.
And attach volume and wait until healthy</p>
<p>Then the volume should have 1 snapshot</p>
<p>When wait for 2 minute.
Then then volume should have only 2 snapshots.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_duplicated"><code class="name flex">
<span>def <span class="ident">test_recurring_job_duplicated</span></span>(<span>client)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test create duplicated recurring jobs</p>
<p>Given recurring job created.
When create same recurring job again.
Then should fail.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_filesystem_trim"><code class="name flex">
<span>def <span class="ident">test_recurring_job_filesystem_trim</span></span>(<span>client, core_api, batch_v1_api, volume_name, csi_pv, pvc, pod_make, access_mode)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job filesystem-trim</p>
<p>Given a workload (volume, pv, pvc, pod).
And create 50mb file in volume.
And actual size of the volume should increase.
And delete the 50mb file in volume.
And actual size of the volume should not decrease.</p>
<p>When create a recurring job with:
- task: filesystem-trim
- retain: 1
Then recurring job retain mutated to 0.</p>
<p>When assign the recurring job to volume.
And wait for the cron job scheduled time.
Then volume actual size should decrease 50mb.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_groups"><code class="name flex">
<span>def <span class="ident">test_recurring_job_groups</span></span>(<span>set_random_backupstore, client, batch_v1_api)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job groups (S3/NFS)</p>
<p>Given volume <code>test-job-1</code> created, attached, and healthy.
volume <code>test-job-2</code> created, attached, and healthy.
And create <code>snapshot</code> recurring job with <code>group-1, group-2</code> in groups.
set cron job to run every 2 minutes.
set retain to 1.
create <code>backup</code>
recurring job with <code>group-1</code>
in groups.
set cron job to run every 3 minutes.
set retain to 1</p>
<p>When set <code>group1</code> recurring job in volume <code>test-job-1</code> label.
set <code>group2</code> recurring job in volume <code>test-job-2</code> label.
And write some data to volume <code>test-job-1</code>.
write some data to volume <code>test-job-2</code>.
And wait for 2 minutes.
And write some data to volume <code>test-job-1</code>.
write some data to volume <code>test-job-2</code>.
And wait for 1 minute.</p>
<p>Then volume <code>test-job-1</code> should have 3 snapshots after scheduled time.
volume <code>test-job-2</code> should have 2 snapshots after scheduled time.
And volume <code>test-job-1</code> should have 1 backup after scheduled time.
volume <code>test-job-2</code> should have 0 backup after scheduled time.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_in_storageclass"><code class="name flex">
<span>def <span class="ident">test_recurring_job_in_storageclass</span></span>(<span>set_random_backupstore, client, core_api, storage_class, statefulset)</span>
</code></dt>
<dd>
<div class="desc"><p>Test create volume with StorageClass contains recurring jobs</p>
<ol>
<li>Create a StorageClass with recurring jobs</li>
<li>Create a StatefulSet with PVC template and StorageClass</li>
<li>Verify the recurring jobs run correctly.</li>
</ol></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_in_volume_creation"><code class="name flex">
<span>def <span class="ident">test_recurring_job_in_volume_creation</span></span>(<span>client, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test create volume with recurring jobs</p>
<p>Given 2 recurring jobs created.
And volume create and a attached.</p>
<p>When label recurring job to volume.
And write data to volume.
wait 2.5 minutes.
And write data to volume.
wait 2.5 minutes.</p>
<p>Then volume have 4 snapshots.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_kubernetes_status"><code class="name flex">
<span>def <span class="ident">test_recurring_job_kubernetes_status</span></span>(<span>set_random_backupstore, client, core_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurringJob properly backs up the KubernetesStatus (S3/NFS)</p>
<p>Given volume created and detached.
And PV from volume created and verified.</p>
<p>When create backup recurring job to run every 2 minutes.
And attach volume.
And write some data to volume.
And wait 5 minutes.</p>
<p>Then volume have 2 snapshots.
volume have 1 backup.
And backup have the Kubernetes Status labels.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_label_on_pvc"><code class="name flex">
<span>def <span class="ident">test_recurring_job_label_on_pvc</span></span>(<span>client, core_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job label on PVC</p>
<p>Given volume created.
And PV created.
and PVC created.
and PVC source recurring job label exists.
and Volume default recurring job label exists.
and RecurringJobs created (recurring-test-1, recurring-test-2).
and RecurringJob (recurring-test-2) is in group (recurring-test-2)</p>
<p>When add a recurring job label (recurring-test-1) on the PVC.
And add a recurring job-group label (recurring-test-2) on the PVC.
Then Volume has recurring job label (recurring-test-1).
And Volume has recurring job-group label (recurring-test-2).</p>
<p>When remove PVC recurring job label (recurring-test-2).
Then Volume has recurring job label (recurring-test-1).</p>
<p>When delete RecurringJobs (recurring-test-1).
Then Volume has recurring job label (default).
And PVC has no recurring job.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_labels"><code class="name flex">
<span>def <span class="ident">test_recurring_job_labels</span></span>(<span>set_random_backupstore, client, random_labels, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test a recurring job with labels (S3/NFS)</p>
<p>Given a recurring job created,
with <code>default</code> in groups,
with random labels.
And volume created and attached.
And write data to volume.</p>
<p>When add another label to the recurring job.
And write data to volume.
And wait after scheduled time.</p>
<p>Then should have 2 snapshots.
And backup should have correct labels.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_multiple_volumes"><code class="name flex">
<span>def <span class="ident">test_recurring_job_multiple_volumes</span></span>(<span>set_random_backupstore, client, batch_v1_api)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job with multiple volumes</p>
<p>Given volume <code>test-job-1</code> created, attached and healthy.
And create <code>backup1</code>
recurring job with <code>default</code> in groups.
create <code>backup2</code>
recurring job with <code>`
in groups.
And &lt;code&gt;default&lt;/code&gt; group exist in</code>test-job-1<code>volume recurring job label.
And &lt;code&gt;backup1&lt;/code&gt; cron job exist.
&lt;code&gt;backup2&lt;/code&gt; cron job exist.
And write data to</code>test-job-1<code>volume.
And 2 snapshot exist in</code>test-job-1<code>volume.
And 1 backup
exist in</code>test-job-1` volume.</p>
<p>When create and attach volume <code>test-job-2</code>.
wait for volume <code>test-job-2</code> to be healthy.
And <code>default</code> group exist in <code>test-job-2</code> volume recurring job label.
And write data to
<code>test-job-1</code> volume.
Then 2 snapshot exist in <code>test-job-2</code> volume.
1 backup
exist in <code>test-job-2</code> volume.</p>
<p>When add <code>backup2</code> in <code>test-job-2</code> volume label.
And <code>default</code> group exist in <code>test-job-1</code> volume recurring job label.
<code>default</code> group exist in <code>test-job-2</code> volume recurring job label.
<code>backup2</code> group exist in <code>test-job-2</code> volume recurring job label.
And write data to <code>test-job-1</code>.
write data to <code>test-job-2</code>.
Then wait for schedule time.
And 2 backup exist in <code>test-job-2</code> volume.
1 backup exist in <code>test-job-1</code> volume.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_restored_from_backup_target"><code class="name flex">
<span>def <span class="ident">test_recurring_job_restored_from_backup_target</span></span>(<span>set_random_backupstore, client, batch_v1_api)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job backup (S3/NFS)</p>
<ol>
<li>Create a volume and attach it to a node or a workload.</li>
<li>Create some recurring jobs (some are in groups)</li>
<li>Label the volume with created recurring jobs (some are in groups)</li>
<li>Create a backup or wait for a recurring job starting</li>
<li>Wait for backup creation completed.</li>
<li>
<p>Check if recurring jobs/groups information is stored in
the backup volume configuration on the backup target</p>
</li>
<li>
<p>Create a volume from the backup just created.</p>
</li>
<li>
<p>Check the volume if it has labels of recurring jobs and groups.</p>
</li>
<li>
<p>Delete recurring jobs that are already stored in the backup volume
on the backup.</p>
</li>
<li>Create a volume from the backup just created.</li>
<li>Check if recurring jobs have been created.</li>
<li>Check if restoring volume has labels of recurring jobs and groups.</li>
</ol></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_snapshot"><code class="name flex">
<span>def <span class="ident">test_recurring_job_snapshot</span></span>(<span>client, batch_v1_api)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job snapshot</p>
<p>Given volume <code>test-job-1</code> created, attached, and healthy.
volume <code>test-job-2</code> created, attached, and healthy.</p>
<p>When create a recurring job with <code>default</code> in groups.
Then should have 1 cron job.
And volume <code>test-job-1</code> should have volume-head 1 snapshot.
volume <code>test-job-2</code> should have volume-head 1 snapshot.</p>
<p>When write some data to volume <code>test-job-1</code>.
write some data to volume <code>test-job-2</code>.
And wait for cron job scheduled time.
Then volume <code>test-job-1</code> should have 2 snapshots after scheduled time.
volume <code>test-job-2</code> should have 2 snapshots after scheduled time.</p>
<p>When write some data to volume <code>test-job-1</code>.
write some data to volume <code>test-job-2</code>.
And wait for cron job scheduled time.
Then volume <code>test-job-1</code> should have 3 snapshots after scheduled time.
volume <code>test-job-2</code> should have 3 snapshots after scheduled time.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_snapshot_cleanup"><code class="name flex">
<span>def <span class="ident">test_recurring_job_snapshot_cleanup</span></span>(<span>set_random_backupstore, client, batch_v1_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job snapshot-cleanup</p>
<p>Given volume created, attached, and healthy.
And 2 snapshot were created by system.
And 1 snapshot were created by user.
And volume has 4 snapshots.
- 2 system-created
- 1 user-created
- 1 volume-head</p>
<p>When create a recurring job with:
- task: system-snapshot-delete
- retain: 1
Then recurring job retain mutated to 0.</p>
<p>When assign the recurring job to volume.
And wait for the cron job scheduled time.
Then volume should have 2 snapshots.
- 0 system-created
- 1 user-created
- 1 volume-head</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_snapshot_delete"><code class="name flex">
<span>def <span class="ident">test_recurring_job_snapshot_delete</span></span>(<span>set_random_backupstore, client, batch_v1_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job snapshot-delete</p>
<p>Given volume created, attached, and healthy.
And 3 snapshots were created.
And volume has 4 snapshots.
- 3 user-created
- 1 volume-head</p>
<p>When create a recurring job with:
- task: snapshot-delete
- retain: 1
And assign the recurring job to volume.
And wait for the cron job scheduled time.</p>
<p>Then volume should have 2 snapshots.
- 1 snapshot retained
- 1 volume-head</p>
<p>When recurring job unassigned to volume.
And create 5 snapshots.
And volume has 7 snapshots.
- 5 new snapshots
- 1 old snapshot
- 1 volume-head
And update recurring job retain to 3.
And assign the recurring job to volume.
And wait for the cron job scheduled time.</p>
<p>Then volume should have 4 snapshots
- 3 snapshots retained
- 1 volume-head</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_snapshot_delete_retain_0"><code class="name flex">
<span>def <span class="ident">test_recurring_job_snapshot_delete_retain_0</span></span>(<span>set_random_backupstore, client, batch_v1_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job snapshot-delete with retain value 0</p>
<p>Given volume created, attached, and healthy.
And 1 snapshots were created.
And volume has 2 snapshots.
- 1 user-created
- 1 volume-head</p>
<p>When create a recurring job with:
- task: snapshot-delete
- retain: 0
And assign the recurring job to volume.
And wait for the cron job scheduled time.</p>
<p>Then volume should have 1 snapshot.
- 0 snapshot retained
- 1 volume-head</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_source_label"><code class="name flex">
<span>def <span class="ident">test_recurring_job_source_label</span></span>(<span>client, core_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring job source label</p>
<p>Given volume created.
And PV created.
and PVC created.
and Volume default recurring job label exists.
and RecurringJob created (recurring-test).</p>
<p>When add source recurring job label on PVC.
And add a recurring job label (recurring-test) on the PVC.
And Volume has recurring job label (recurring-test).</p>
<p>When delete source recurring job label on PVC.
And remove PVC recurring job label (recurring-test).
Then wait some times for volume controller to resync (30 seconds)
And Volume has recurring job label (recurring-test).</p>
<p>When add source recurring job label on PVC.
Then Volume has recurring job label (default).</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_job_volume_label_when_job_and_group_use_same_name"><code class="name flex">
<span>def <span class="ident">test_recurring_job_volume_label_when_job_and_group_use_same_name</span></span>(<span>client, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test volume label recurring job when recurring job and
job-group uses the same name.</p>
<p>Given volume-1 created.
volume-2 created.
volume-3 created.
And
create <code>snapshot1</code> recurring job with <code>snapshot-1</code> in groups.
create <code>snapshot2</code> recurring job with <code>snapshot-1</code> in groups.
And
<code>snapshot1</code> job-group applied to volume-1.
<code>snapshot1</code> job
applied to volume-2.
<code>snapshot2</code> job
applied to volume-3.
And
<code>snapshot1</code> job-group exist in volume-1 recurring job label.
<code>snapshot1</code> job
exist in volume-2 recurring job label.
<code>snapshot2</code> job
exist in volume-3 recurring job label.</p>
<p>When delete <code>snapshot1</code> recurring job.
Then <code>snapshot1</code> job-group
exist in volume-1 recurring job label.
<code>snapshot1</code> job
not exist in volume-2 recurring job label.
<code>snapshot2</code> job
exist in volume-3 recurring job label.</p>
<p>When delete <code>snapshot2</code> recurring job.
Then <code>snapshot1</code> job-group not exist in volume-1 recurring job label.
<code>snapshot2</code> job
not exist in volume-3 recurring job label.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_jobs_allow_detached_volume"><code class="name flex">
<span>def <span class="ident">test_recurring_jobs_allow_detached_volume</span></span>(<span>set_random_backupstore, client, core_api, apps_api, volume_name, make_deployment_with_pvc)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring jobs for detached volume with
<code>allow-recurring-job-while-volume-detached</code> set to true</p>
<p>Context: In the current Longhorn implementation, users cannot do recurring
backup when volumes are detached.
This feature gives the users an option to do recurring backup
even when volumes are detached.
longhorn/longhorn#1509</p>
<p>Given <code>allow-recurring-job-while-volume-detached</code> set to <code>true</code>.
And volume created and attached.
And 50MB data written to volume.
And volume detached.</p>
<p>When a recurring job created runs every minute.
And wait for backup to complete.</p>
<p>Then volume have 1 backup in 2 minutes retry loop.</p>
<p>When delete the recurring job.
And create a PV from volume.
And create a PVC from volume.
And create a deployment from PVC.
And write 400MB data to the volume from the pod.
And scale deployment replicas to 0.
wait until the volume is detached.
And create a recurring job runs every 2 minutes.
And wait for backup to start.
And scale deployment replicas to 1.
Then volume's frontend is disabled.
And pod cannot start.</p>
<p>When wait until backup complete.
And delete the recurring job.
Then pod can start in 10 minutes retry loop.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_jobs_maximum_retain"><code class="name flex">
<span>def <span class="ident">test_recurring_jobs_maximum_retain</span></span>(<span>client, core_api, volume_name)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring jobs' maximum retain</p>
<p>Given set a recurring job retain to 101.</p>
<p>When create recurring job.
Then should fail.</p>
<p>When set recurring job retain to 100.
And create recurring job.
Then recurring job created with retain equals to 100.</p>
<p>When update recurring job retain to 101.
Then should fail.</p></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_jobs_on_nodes_with_taints"><code class="name flex">
<span>def <span class="ident">test_recurring_jobs_on_nodes_with_taints</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Test recurring jobs on nodes with taints</p>
<p>Context:</p>
<p>Test the prevention of creation of multiple pods due to
recurring job's pod being rejected by Taint controller
on nodes with taints</p>
<p>Steps:</p>
<ol>
<li>Set taint toleration for Longhorn components
<code>persistence=true:NoExecute</code></li>
<li>Taint <code>node-1</code> with <code>persistence=true:NoExecute</code></li>
<li>Create a volume, vol-1.
Attach vol-1 to node-1
Write some data to vol-1</li>
<li>Create a recurring backup job which:
Has retain count 10
Runs every minute</li>
<li>
<p>Wait for 3 minutes.
Verify that the there is 1 backup created
Verify that the total number of pod in longhorn-system namespace &lt; 50
Verify that the number of pods of the cronjob is &lt;= 2</p>
</li>
<li>
<p>Taint all nodes with <code>persistence=true:NoExecute</code></p>
</li>
<li>Write some data to vol-1</li>
<li>
<p>Wait for 3 minutes.
Verify that the there are 2 backups created in total
Verify that the total number of pod in longhorn-system namespace &lt; 50
Verify that the number of pods of the cronjob is &lt;= 2</p>
</li>
<li>
<p>Remove <code>persistence=true:NoExecute</code> from all nodes and Longhorn setting
Clean up backups, volumes</p>
</li>
</ol></div>
</dd>
<dt id="tests.test_recurring_job.test_recurring_jobs_when_volume_detached_unexpectedly"><code class="name flex">
<span>def <span class="ident">test_recurring_jobs_when_volume_detached_unexpectedly</span></span>(<span>set_random_backupstore, client, core_api, apps_api, volume_name, make_deployment_with_pvc)</span>
</code></dt>
<dd>
<div class="desc"><p>Scenario: test recurring jobs when volume detached unexpectedly</p>
<p>Context: If the volume is automatically attached by the recurring backup
job, make sure that workload pod eventually is able to use the
volume when volume is detached unexpectedly during the backup
process.</p>
<p>Given <code>allow-recurring-job-while-volume-detached</code> set to <code>true</code>.
And volume created and detached.
And PV created from volume.
And PVC created from volume.
And deployment created from PVC.
And 500MB data written to the volume.
And deployment replica scaled to 0.
And volume detached.</p>
<p>When create a backup recurring job runs every 2 minutes.
And wait for backup to start.
wait for backup progress &gt; 50%.
And kill the engine process of the volume.
Then volume is attached and healthy.</p>
<p>When backup completed.
Then volume is detached with <code>frontendDisabled=false</code>.</p>
<p>When deployment replica scaled to 1.
Then the data exist in the deployment pod.</p></div>
</dd>
<dt id="tests.test_recurring_job.wait_for_actual_size_change_mb"><code class="name flex">
<span>def <span class="ident">wait_for_actual_size_change_mb</span></span>(<span>client, vol_name, old_size, retry_counts=60, wait_stablize=True)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="tests.test_recurring_job.wait_for_recurring_backup_to_start"><code class="name flex">
<span>def <span class="ident">wait_for_recurring_backup_to_start</span></span>(<span>client, core_api, volume_name, expected_snapshot_count, minimum_progress=0)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="tests.test_recurring_job.wait_until_begin_of_a_minute"><code class="name flex">
<span>def <span class="ident">wait_until_begin_of_a_minute</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="tests.test_recurring_job.wait_until_begin_of_an_even_minute"><code class="name flex">
<span>def <span class="ident">wait_until_begin_of_an_even_minute</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="tests" href="index.html">tests</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="tests.test_recurring_job.add_recurring_job_source_to_pvc" href="#tests.test_recurring_job.add_recurring_job_source_to_pvc">add_recurring_job_source_to_pvc</a></code></li>
<li><code><a title="tests.test_recurring_job.recurring_job_labels_test" href="#tests.test_recurring_job.recurring_job_labels_test">recurring_job_labels_test</a></code></li>
<li><code><a title="tests.test_recurring_job.remove_recurring_job_source_to_pvc" href="#tests.test_recurring_job.remove_recurring_job_source_to_pvc">remove_recurring_job_source_to_pvc</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job" href="#tests.test_recurring_job.test_recurring_job">test_recurring_job</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_backup" href="#tests.test_recurring_job.test_recurring_job_backup">test_recurring_job_backup</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_default" href="#tests.test_recurring_job.test_recurring_job_default">test_recurring_job_default</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_delete" href="#tests.test_recurring_job.test_recurring_job_delete">test_recurring_job_delete</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_delete_should_remove_volume_label" href="#tests.test_recurring_job.test_recurring_job_delete_should_remove_volume_label">test_recurring_job_delete_should_remove_volume_label</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_detached_volume" href="#tests.test_recurring_job.test_recurring_job_detached_volume">test_recurring_job_detached_volume</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_duplicated" href="#tests.test_recurring_job.test_recurring_job_duplicated">test_recurring_job_duplicated</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_filesystem_trim" href="#tests.test_recurring_job.test_recurring_job_filesystem_trim">test_recurring_job_filesystem_trim</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_groups" href="#tests.test_recurring_job.test_recurring_job_groups">test_recurring_job_groups</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_in_storageclass" href="#tests.test_recurring_job.test_recurring_job_in_storageclass">test_recurring_job_in_storageclass</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_in_volume_creation" href="#tests.test_recurring_job.test_recurring_job_in_volume_creation">test_recurring_job_in_volume_creation</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_kubernetes_status" href="#tests.test_recurring_job.test_recurring_job_kubernetes_status">test_recurring_job_kubernetes_status</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_label_on_pvc" href="#tests.test_recurring_job.test_recurring_job_label_on_pvc">test_recurring_job_label_on_pvc</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_labels" href="#tests.test_recurring_job.test_recurring_job_labels">test_recurring_job_labels</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_multiple_volumes" href="#tests.test_recurring_job.test_recurring_job_multiple_volumes">test_recurring_job_multiple_volumes</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_restored_from_backup_target" href="#tests.test_recurring_job.test_recurring_job_restored_from_backup_target">test_recurring_job_restored_from_backup_target</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_snapshot" href="#tests.test_recurring_job.test_recurring_job_snapshot">test_recurring_job_snapshot</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_snapshot_cleanup" href="#tests.test_recurring_job.test_recurring_job_snapshot_cleanup">test_recurring_job_snapshot_cleanup</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_snapshot_delete" href="#tests.test_recurring_job.test_recurring_job_snapshot_delete">test_recurring_job_snapshot_delete</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_snapshot_delete_retain_0" href="#tests.test_recurring_job.test_recurring_job_snapshot_delete_retain_0">test_recurring_job_snapshot_delete_retain_0</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_source_label" href="#tests.test_recurring_job.test_recurring_job_source_label">test_recurring_job_source_label</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_job_volume_label_when_job_and_group_use_same_name" href="#tests.test_recurring_job.test_recurring_job_volume_label_when_job_and_group_use_same_name">test_recurring_job_volume_label_when_job_and_group_use_same_name</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_jobs_allow_detached_volume" href="#tests.test_recurring_job.test_recurring_jobs_allow_detached_volume">test_recurring_jobs_allow_detached_volume</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_jobs_maximum_retain" href="#tests.test_recurring_job.test_recurring_jobs_maximum_retain">test_recurring_jobs_maximum_retain</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_jobs_on_nodes_with_taints" href="#tests.test_recurring_job.test_recurring_jobs_on_nodes_with_taints">test_recurring_jobs_on_nodes_with_taints</a></code></li>
<li><code><a title="tests.test_recurring_job.test_recurring_jobs_when_volume_detached_unexpectedly" href="#tests.test_recurring_job.test_recurring_jobs_when_volume_detached_unexpectedly">test_recurring_jobs_when_volume_detached_unexpectedly</a></code></li>
<li><code><a title="tests.test_recurring_job.wait_for_actual_size_change_mb" href="#tests.test_recurring_job.wait_for_actual_size_change_mb">wait_for_actual_size_change_mb</a></code></li>
<li><code><a title="tests.test_recurring_job.wait_for_recurring_backup_to_start" href="#tests.test_recurring_job.wait_for_recurring_backup_to_start">wait_for_recurring_backup_to_start</a></code></li>
<li><code><a title="tests.test_recurring_job.wait_until_begin_of_a_minute" href="#tests.test_recurring_job.wait_until_begin_of_a_minute">wait_until_begin_of_a_minute</a></code></li>
<li><code><a title="tests.test_recurring_job.wait_until_begin_of_an_even_minute" href="#tests.test_recurring_job.wait_until_begin_of_an_even_minute">wait_until_begin_of_an_even_minute</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.0</a>.</p>
</footer>
</body>
</html>
