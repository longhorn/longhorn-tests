<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Longhorn Manual Test Cases
    </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
    <style>
      ol > li { list-style-type: decimal; }
    </style>
  </head>
  <body class="markdown-body" style="display: flex; padding: 1%;">
    
<aside style="width: 30%; padding: 1%; border-right: 1px solid lightgray;">
  <a href="https://longhorn.github.io/longhorn-tests/manual"><h2>Manual Test Cases</h2></a>
  
  <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/">Functional test cases</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/deployment/"> Deployment of Longhorn  </a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/ui/">UI  </a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/volume/">Volume  </a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/kubernetes/">Kubernetes  </a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/backup/">Backup  </a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/node/">Node  </a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/scheduling/">Scheduling  </a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/upgrade/">Upgrade  </a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/functional-test-cases/monitoring/">Monitoring</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/">Pre-release tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/">Backup &amp; Restore tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/dr-volume-live-upgrade-and-rebuild/">#1279 DR volume live upgrade and rebuild</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/concurrent-backup/">#1341 concurrent backup test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/google-cloud-s3-interop-backups/">#1404 test backup functionality on google cloud and other s3 interop providers.</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/pull-backup-created-by-another-longhorn/">#4637 pull backup created by another Longhorn system</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/backup-and-restore/sync-up-with-backup-target-during-dr-volume-activation/">Sync up with backup target during DR volume activation</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/basic-operations/">Basic operations</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/basic-operations/snapshot-while-writing-data/">Snapshot while writing data in the volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/basic-operations/storage-network/">Storage Network Test</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/cluster-restore/">Cluster Restore</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/cluster-restore/restore-to-a-new-cluster/">Restore to a new cluster</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/cluster-restore/restore-to-an-old-cluster/">Restore to an old cluster</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/">Environment</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/cluster-using-customized-kubelet-root-directory/">Cluster using customize kubelet root directory</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/k3s-selinux-compatibility/">Compatibility with k3s and SELinux</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/rke2-cis-1.6-profile/">Test Longhorn deployment on RKE2 v1.24- with CIS-1.6 profile</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/environment/rke2-cis-1.23-profile/">Test Longhorn deployment on RKE2 v1.25+ with CIS-1.23 profile</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/">HA</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/backing-image-error-reporting-and-retry/">Backing Image Error Reporting and Retry</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/disk-migration-in-aws-asg/">Disk migration in AWS ASG</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/ha-volume-migration/">HA Volume Migration</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ha/replica-rebuilding/">Replica Rebuilding</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/">Managed Kubernetes Clusters (EKS, GKE, AKS)</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/aks/">AKS</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/aks/expand-volume/">Expand Volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/aks/upgrade-k8s/">Upgrade K8s</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/eks/">EKS</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/eks/add-extra-volume/">Add Extra Volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/eks/expand-volume/">Expand Volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/eks/upgrade-k8s/">Upgrade K8s</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/gke/">GKE</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/gke/expand-volume/">Expand Volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/managed-kubernetes-clusters/gke/upgrade-k8s/">Upgrade K8s</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/">Node</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/degraded-availability/">Degraded availability with added nodes</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node/improve-node-failure-handling/">Improve Node Failure Handling By Automatically Force Delete Terminating Pods of StatefulSet/Deployment On Downed Node</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/">Node Not Ready</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/kubelet-restart/">Kubulete Restart</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/kubelet-restart/kubelet-restart-on-a-node/">Test kubelet restart on a node of the cluster</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/node-down/">Node Down</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/node-down/restore-volume-node-down/">#1355 The node the restore volume attached to is down</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/node-down/backing-image-on-a-down-node/">Backing Image on a down node</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/node-down/node-drain-deletion/">Node drain and deletion test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/node-down/physical-node-down/">Physical node down</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/node-down/node-deletion/">Test node deletion</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/node-restart/">Node Restart</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/node-not-ready/node-restart/dr-volume-node-rebooted/">#1366 &amp;&amp; #1328 The node the DR volume attached to is rebooted</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/resiliency/">Resiliency</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/resiliency/simulated-slow-disk/">#2206 Fix the spinning disk on Longhorn</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/resiliency/pvc_provisioning_with_insufficient_storage/">PVC provisioning with insufficient storage</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/resiliency/test-longhorn-component-recovery/">Test Longhorn components recovery</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/resiliency/timeout/">Test timeout on loss of network connectivity</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stability/">Stability</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stability/checksum-enabled-large-volume/">Checksum enabled large volume with multiple rebuilding</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stability/multiple-installation/">Longhorn installation multiple times</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/stress/backup-listing/">Test backup listing S3/NFS</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ui/">UI</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/ui/ui-sanity-check/">ui sanity check</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/uninstallation/uninstallation-checks/">Uninstallation Checks</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/">Upgrade</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/auto-upgrade-engine/">Automatically Upgrading Longhorn Engine Test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/kubernetes-upgrade-test/">Kubernetes upgrade test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/longhorn-upgrade-test/">Longhorn Upgrade test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/update_csi_components_when_images_change/">Re-deploy CSI components when their images change</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/backing-image-during-upgrade/">Test Backing Image during Longhorn upgrade</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/engine-crash-during-live-upgrade/">Test Engine Crash During Live Upgrade</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/test-node-drain-policy/">Test Node Drain Policy Setting</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/upgrade-with-customized-storage-class/">Test system upgrade with a new storage class being default</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/upgrade-with-new-instance-manager/">Test System Upgrade with New Instance Manager</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/upgrade/upgrade-conflict-handling/">Upgrade Conflict Handling test</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/v2-volume/">v2 volume</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/pre-release/v2-volume/sanity-check/">v2 volume sanity check</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/rancher-integration/">Rancher integration test cases</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/rancher-integration/access-lh-gui-using-rancher-ui/">Access Longhorn GUI using Rancher proxy</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/rancher-integration/drain-using-rancher-ui/">Drain using Rancher UI</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/rancher-integration/lh-hardend-rancher/">Longhorn in an hardened cluster</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/rancher-integration/fleet-deploy/">Longhorn using fleet on multiple downstream clusters</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/rancher-integration/upgrade-using-rancher-ui/">Upgrade Kubernetes using Rancher UI</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/rancher-integration/upgrade-using-suc/">Upgrade Kubernetes using SUC</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/">Release specific tests</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/">v1.0.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/new-node-custom-data-directory/">New Node with Custom Data Directory</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/">Operating System specific tests for SUSE SLES12SP3</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-custom-fs-params-1/">Testing ext4 with custom fs params1 (no 64bit, no metadata_csum)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-custom-fs-params-2/">Testing ext4 with custom fs params2 (no metadata_csum)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/ext4-no-custom-fs-params/">Testing ext4 without custom fs params</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.0/suse-sles12sp3/xfs-after-custom-fs-params/">Testing xfs after custom fs params (xfs should ignore the custom fs params)</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/">v1.0.1</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/besteffort-recurring-job/">BestEffort Recurring Job Cleanup</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/change-imagepullpolicy/">Change imagePullPolicy to IfNotPresent Test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/dr-volume-latest-backup-deletion/">DR volume related latest backup deletion test</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/nfsv4-enforcement/">NFSv4 Enforcement (No NFSv3 Fallback)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/priorityclass-default-setting/">Priority Class Default Setting</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/error-fail-remount/">Return an error when fail to remount a volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/test-s3-access-style/">Test access style for S3 compatible backupstore</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/test-s3-backupstore/">Test S3 backupstore in a cluster sitting behind a HTTP proxy</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.1/ui-volume-deletion/">Volume Deletion UI Warnings</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.2/">v1.0.2</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.0.2/upgrade-lease-lock/">Upgrade Lease Lock</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/">v1.1.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/prometheus_support/">Prometheus Support</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/recurring-backup-job-interruptions/">Recurring backup job interruptions</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/reusing-failed-replica-for-rebuilding/">Reusing failed replica for rebuilding</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/kubelet_volume_metrics/">Support Kubelet Volume Metrics</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/additional-printer-columns/">Test Additional Printer Columns</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/instance-manager-ip-sync/">Test Instance Manager IP Sync</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/iscsi_installation/">Test ISCSI Installation on EKS</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/rwx_feature/">Test Read Write Many Feature</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/uninstallation/">Test uninstallation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.0/upgrade_with_modified_storageclass/">Upgrade Longhorn with modified Storage Class</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/">v1.1.1</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/csi-sanity-check/">CSI Sanity Check</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/partial-engine-deployment/">Longhorn with engine is not deployed on all the nodes</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/tolerations_priorityclass_setting/">Set Tolerations/PriorityClass For System Components</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/disable_ipv6/">Test Disable IPv6</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/test-file-sync-cancellation/">Test File Sync Cancellation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/ws-traffic-flood/">Test Frontend Traffic</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/delete-node/">Test Node Delete</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/test-node-selector/">Test Node Selector</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/rwx-mount-ownership-reset/">Test RWX share-mount ownership reset</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/test-service-account-mount/">Test Service Account mount on host</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/snapshot-purge-error-handling/">Test Snapshot Purge Error Handling</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.1/system-upgrade-with-deprecated-cpu-setting/">Test system upgrade with the deprecated CPU setting</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.2/">v1.1.2</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.2/delete-cronjob-for-detached-volumes/">Test CronJob For Volumes That Are Detached For A Long Time</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.2/full-ws-data-tranfer-when-no-updates/">Test Frontend Web-socket Data Transfer When Resource Not Updated</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.1.2/instance-manager-streaming-connection-recovery/">Test Instance Manager Streaming Connection Recovery</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.0/">v1.2.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.0/test-backing-image-upload/">Test backing image</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.0/backup-creation-with-old-engine-image/">Test Backup Creation With Old Engine Image</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.0/test-instance-manager-cleanup-during-uninstall/">Test instance manager cleanup during uninstall</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.0/label-driven-recurring-job/">Test Label-driven Recurring Job</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.0/test_version_bump/">Test Version Bump of Kubernetes, API version group, CSI component&rsquo;s dependency version</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.3/">v1.2.3</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.3/test-backing-image-checksum-mismatching/">Test backing image checksum mismatching</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.3/test-backing-image-space-usage/">Test backing image space usage with sparse files</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.2.3/test-scalability-with-backing-image/">Test scalability with backing image</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/">v1.3.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/extend_csi_snapshot_support/">Extended CSI snapshot support to Longhorn snapshot</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-storage-network/">Setup and test storage network</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-backing-image-download-to-local/">Test backing image download to local</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-helm-uninstall-different-namespace/">Test Helm uninstall Longhorn in different namespace</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-grpc-proxy/">Test IM Proxy connection metrics</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-instance-manager-npe/">Test instance manager NPE</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-longhorn-manager-npe/">Test longhorn manager NPE caused by backup creation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-longhorn-manager-starting-scalability/">Test longhorn manager pod starting scalability</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-npe-when-longhorn-ui-deployment-not-exist/">Test NPE when longhorn UI deployment CR not exist</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.0/test-snapshot-purge-retry/">Test snapshot purge retry</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.1/">v1.3.1</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.3.1/test-backing-image-download-to-local/">Test transient error in engine status during eviction</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/">v1.4.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-csi-plugin-liveness-probe/">Test CSI plugin liveness probe</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-engine-binary-recovery/">Test engine binary recovery</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-filesystem-trim/">Test filesystem trim</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-helm-install-on-rancher-deployed-windows-cluster/">Test helm on Rancher deployed Windows Cluster</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-system-backup/">Test Longhorn system backup should sync from the remote backup target</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-node-id-change-during-backing-image-creation/">Test Node ID Change During Backing Image Creation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-online-expansion/">Test Online Expansion</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-replica-scale-down-warning/">Test replica scale-down warning</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.0/test-upgrade-for-migrated-longhorn/">Test upgrade for migrated Longhorn on Rancher</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.1/">v1.4.1</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.4.1/test-the-trim-related-option-update-for-old-volumes/">Test the trim related option update for old volumes</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.5.0/">v1.5.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.5.0/test-upgrade-responder-collect-extra-info/">Test upgrade responder collecting extra info</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.5.0/test-the-volume-replica-scheduling/">Test Volume Replica Zone Soft Anti-Affinity Setting</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/">v1.6.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-upgrade-responder-collectiing-average-sizes-for-v1-volumes-only/"></a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-storage-network/">Setup and test storage network when Multus version is above v4.0.0</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-rebuild-in-meta-blocks-engine-start/">Test Rebuild in volume.meta blocks engine start</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-engine-version-enforcement/">Test engine version enforcement</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-list-backup-when-cluster-has-node-cordoned-before-longhorn-installation/">Test list backup when cluster has node cordoned before Longhorn installation</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-pvc-name-and-namespace-included-in-volume-metrics/">Test PVC Name and Namespace included in the volume metrics</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-replica-disk-soft-anti-affinity/">Test Replica Disk Soft Anti-Affinity</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-support-bundle-metadata-file/">Test Support Bundle Metadata File</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-support-bundle-kubelet-log-for-k3s/">Test Support Bundle Should Include Kubelet Log When On K3s Cluster</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-support-bundle-syslog-paths/">Test Support Bundle Syslog Paths</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.6.0/test-upgrade-responder-collect-spdk-related-info/">Test upgrade responder should collect SPDK related info</a></li>
  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/">v1.7.0</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/test-gke-container-optimized-os-dependency-setup/">Dependency setup for GKE cluster using Container-Optimized OS as base image</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/test-longhorn-cli-longhornctl/">Longhorn Commandline Interface (longhornctl)</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/test-node-disk-support/">Node Disk Support</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/test-kubelet-restart-no-pending-pod-event/">restarting Kubelet should not result in repeated &ldquo;no Pending workload pods &hellip;&rdquo; event for the workload pod.</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/test-rwx-fast-failover/">RWX Fast Failover</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/test-storage-network-support-for-rwx-volume/">Storage Network Support for RWX Volume</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/test-support-bundle-node-collection-timeout/">Support bundle node collection timeout</a></li>
  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/release-specific/v1.7.0/test-build-image-package-up-to-date/">System Packages Are Up-to-date During Image Build</a></li>
  

</ul>

  

</ul>

  

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/test-cases-to-reproduce-attach-detach-issues/">Test cases to reproduce issues related to attach detach</a></li>
  
    <ul>

  <li><a href="https://longhorn.github.io/longhorn-tests/manual/test-cases-to-reproduce-attach-detach-issues/attachment-detachment-issues-reproducibility/">Test cases to reproduce attachment-detachment issues</a></li>
  

</ul>

  

</ul>

  
</aside>


<main style="padding: 1%; width: 70%;">
  <h1 id="title">HA Volume Migration</h1>
  <div>
    <article id="content">
       <h2 id="related-issues">Related issues</h2>
<ul>
<li><a href="https://github.com/longhorn/longhorn/issues/3401">https://github.com/longhorn/longhorn/issues/3401</a></li>
<li><a href="https://github.com/longhorn/longhorn/issues/8735">https://github.com/longhorn/longhorn/issues/8735</a></li>
</ul>
<h2 id="basic-instructions">Basic instructions</h2>
<ol>
<li>Deploy a migratable StorageClass. E.g.:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-sc</span>
<span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">driver.longhorn.io</span>
<span style="color:#f92672">allowVolumeExpansion</span>: <span style="color:#66d9ef">true</span>
<span style="color:#f92672">parameters</span>:
  <span style="color:#f92672">numberOfReplicas</span>: <span style="color:#e6db74">&#34;3&#34;</span>
  <span style="color:#f92672">migratable</span>: <span style="color:#e6db74">&#34;true&#34;</span>
</code></pre></div><ol start="2">
<li>Create a migratable Volume. E.g.:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-pvc</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">accessModes</span>:
    - <span style="color:#ae81ff">ReadWriteMany</span>
  <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Block</span>
  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">test-sc</span>
  <span style="color:#f92672">resources</span>:
    <span style="color:#f92672">requests</span>:
      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</code></pre></div><ol start="3">
<li>Attach the volume to a node and wait for it to become running. E.g.:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">VolumeAttachment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-va-1</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">attacher</span>: <span style="color:#ae81ff">driver.longhorn.io</span>
  <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">&lt;old_node&gt;</span>
  <span style="color:#f92672">source</span>:
    <span style="color:#f92672">persistentVolumeName</span>: <span style="color:#ae81ff">&lt;volume_name&gt;</span>
</code></pre></div><ol start="4">
<li>Write some data into the volume.</li>
<li>Start the migration by attaching the volume to a second node.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">VolumeAttachment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-va-2</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">attacher</span>: <span style="color:#ae81ff">driver.longhorn.io</span>
  <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">&lt;new_node&gt;</span>
  <span style="color:#f92672">source</span>:
    <span style="color:#f92672">persistentVolumeName</span>: <span style="color:#ae81ff">&lt;volume_name&gt;</span>
</code></pre></div><ol start="6">
<li>Trigger the scenarios described below with commands like:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Attempt to confirm the migration by detaching from &lt;old_node&gt;.</span>
kubectl -n longhorn-system delete -f va-1.yaml

<span style="color:#75715e"># Attempt to roll back the migration by detaching from &lt;new_node&gt;.</span>
kubectl -n longhorn-system delete -f va-2.yaml

<span style="color:#75715e"># Check the migration status of the volume.</span>
kubectl -n longhorn-system get volume -oyaml | grep -i nodeid

<span style="color:#75715e"># View migration related logs.</span>
kubetail -n longhorn-system -l <span style="color:#e6db74">&#39;app in (longhorn-manager,longhorn-csi-plugin)&#39;</span>

<span style="color:#75715e"># Watch volume to check if it becomes detached or faulted.</span>
kubectl -n longhorn-system get volume -oyaml -w | grep -e state -e robustness

<span style="color:#75715e"># Check the names of engines and replicas before and then after triggering the scenario for comparison. </span>
<span style="color:#75715e"># - Some scenarios result in a new engine becoming active (e.g. test-e-0 is replaced by test-e-1).</span>
<span style="color:#75715e"># - Some scenarios result in new replicas becoming active (e.g. test-r-45032d2c is gone, but test-r-b28953eb is in its</span>
<span style="color:#75715e">#   place).</span>
kubectl -n longhorn-system get engine
kubectl -n longhorn-system get replica
</code></pre></div><ol start="7">
<li>Before a test, verify the volume migration is ready. Logs should indicate &ldquo;Volume migration engine is ready&rdquo;, and:</li>
</ol>
<pre tabindex="0"><code>kubectl -n longhorn-system get volume -oyaml | grep -i nodeid
    migrationNodeID: eweber-v126-worker-9c1451b4-6464j
    nodeID: eweber-v126-worker-9c1451b4-kgxdq
    currentMigrationNodeID: eweber-v126-worker-9c1451b4-6464j
    currentNodeID: eweber-v126-worker-9c1451b4-kgxdq
    pendingNodeID: &quot;&quot;
</code></pre><h2 id="scenarios">Scenarios</h2>
<h3 id="1-new-engine-crash">1. New engine crash</h3>
<p>Crash the engine on the migration node by killing its instance-manager pod.</p>
<h4 id="11-confirmation-immediately-after-crash">1.1. Confirmation immediately after crash</h4>
<p>Migration engine and replicas are recreated. Then, confirmation succeeds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kl delete --wait<span style="color:#f92672">=</span>false pod instance-manager-ea5f8778d6c99e747289ff09c322d75a <span style="color:#f92672">&amp;&amp;</span> sleep 0.5 <span style="color:#f92672">&amp;&amp;</span> k delete -f va-1.yaml
<span style="color:#75715e"># OR</span>
kl delete --wait<span style="color:#f92672">=</span>false pod instance-manager-ea5f8778d6c99e747289ff09c322d75a <span style="color:#f92672">&amp;&amp;</span> sleep <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> k delete -f va-1.yaml
</code></pre></div><ul>
<li>&ldquo;Waiting to confirm migration until migration engine is ready&rdquo;</li>
<li>&ldquo;Confirming migration&rdquo;</li>
<li>No detachment</li>
<li>New engine and replicas</li>
</ul>
<h4 id="12-confirmation-immediately-before-crash">1.2. Confirmation immediately before crash</h4>
<p>Confirmation succeeds. Then, the volume detaches from and reattaches to the new node.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">k delete --wait<span style="color:#f92672">=</span>false -f va-1.yaml <span style="color:#f92672">&amp;&amp;</span> sleep 0.5 <span style="color:#f92672">&amp;&amp;</span> kl delete pod instance-manager-ea5f8778d6c99e747289ff09c322d75a
<span style="color:#75715e"># OR</span>
k delete --wait<span style="color:#f92672">=</span>false -f va-1.yaml <span style="color:#f92672">&amp;&amp;</span> sleep <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> kl delete pod instance-manager-ea5f8778d6c99e747289ff09c322d75a
</code></pre></div><ul>
<li>&ldquo;Confirming migration&rdquo;</li>
<li>&ldquo;&hellip;selected to detach from <new>&rdquo;</li>
<li>&ldquo;&hellip;selected to attach to <new>&rdquo;</li>
<li>New engine and replicas</li>
</ul>
<h4 id="13-rollback-immediately-before-or-after-crash">1.3. Rollback immediately before or after crash</h4>
<p>Rollback succeeds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kl delete --wait<span style="color:#f92672">=</span>false pod instance-manager-ea5f8778d6c99e747289ff09c322d75a <span style="color:#f92672">&amp;&amp;</span> sleep 0.5 <span style="color:#f92672">&amp;&amp;</span> k delete -f va-2.yaml
<span style="color:#75715e"># OR</span>
kl delete --wait<span style="color:#f92672">=</span>false pod instance-manager-ea5f8778d6c99e747289ff09c322d75a <span style="color:#f92672">&amp;&amp;</span> sleep <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> k delete -f va-2.yaml
<span style="color:#75715e"># OR</span>
k delete --wait<span style="color:#f92672">=</span>false -f va-2.yaml <span style="color:#f92672">&amp;&amp;</span> sleep 0.5 <span style="color:#f92672">&amp;&amp;</span> kl delete pod instance-manager-ea5f8778d6c99e747289ff09c322d75a
<span style="color:#75715e"># OR</span>
k delete --wait<span style="color:#f92672">=</span>false -f va-2.yaml <span style="color:#f92672">&amp;&amp;</span> sleep <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> kl delete pod instance-manager-ea5f8778d6c99e747289ff09c322d75a
</code></pre></div><ul>
<li>&ldquo;Rolling back migration&rdquo;</li>
<li>No detachment</li>
<li>Same engine and replicas</li>
</ul>
<h3 id="2-old-engine-crash">2. Old engine crash</h3>
<p>Crash the engine on the old node by killing its instance-manager pod.</p>
<h4 id="21-no-immediate-confirmation-or-rollback">2.1 No immediate confirmation or rollback</h4>
<p>The volume completely detaches and remains detached. Logs indicate next steps. Deleting either of the two
VolumeAttachments gets the volume unstuck.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kl delete pod instance-manager-699da83c0e9d22726e667344227e096b
</code></pre></div><ul>
<li>&ldquo;&hellip;selected to detach from <old>&rdquo;</li>
<li>&ldquo;Cancelling migration for detached volume&hellip;&rdquo;</li>
<li>MigrationFailed event</li>
<li>&ldquo;Volume migration between <old> and <new> failed; detach volume from extra node to resume&rdquo;</li>
</ul>
<pre tabindex="0"><code>kubectl -n longhorn-system get volume -oyaml | grep -i nodeid
    migrationNodeID: &quot;&quot;
    nodeID: &quot;&quot;
    currentMigrationNodeID: &quot;&quot;
    currentNodeID: &quot;&quot;
    pendingNodeID: &quot;&quot;
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kl delete -f va-2.yaml
</code></pre></div><pre tabindex="0"><code>kubectl -n longhorn-system get volume -oyaml | grep -i nodeid
    migrationNodeID: &quot;&quot;
    nodeID: eweber-v126-worker-9c1451b4-kgxdq
    currentMigrationNodeID: &quot;&quot;
    currentNodeID: eweber-v126-worker-9c1451b4-kgxdq
    pendingNodeID: &quot;&quot;
</code></pre><h4 id="22-confirmation-immediately-after-crash">2.2 Confirmation immediately after crash</h4>
<p>The volume automatically detaches from the old node. Then, it reattaches to the new node.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kl delete --wait<span style="color:#f92672">=</span>false pod instance-manager-699da83c0e9d22726e667344227e096b <span style="color:#f92672">&amp;&amp;</span> sleep 0.5 <span style="color:#f92672">&amp;&amp;</span> k delete -f va-1.yaml
<span style="color:#75715e"># OR</span>
kl delete --wait<span style="color:#f92672">=</span>false pod instance-manager-699da83c0e9d22726e667344227e096b <span style="color:#f92672">&amp;&amp;</span> sleep <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> k delete -f va-1.yaml
</code></pre></div><ul>
<li>&ldquo;&hellip;selected to detach from <old>&rdquo;</li>
<li>&ldquo;Cancelling migration for detached volume&hellip;&rdquo;</li>
<li>MigrationFailed event</li>
<li>&ldquo;&hellip;selected to attach to <new>&rdquo;</li>
<li>Same engine and replicas</li>
</ul>
<h4 id="23-confirmation-immediately-before-crash">2.3 Confirmation immediately before crash</h4>
<p>Confirmation succeeds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">k delete --wait<span style="color:#f92672">=</span>false -f va-1.yaml <span style="color:#f92672">&amp;&amp;</span> sleep 0.5 <span style="color:#f92672">&amp;&amp;</span> kl delete pod instance-manager-699da83c0e9d22726e667344227e096b
<span style="color:#75715e"># OR</span>
k delete --wait<span style="color:#f92672">=</span>false -f va-1.yaml <span style="color:#f92672">&amp;&amp;</span> sleep <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> kl delete pod instance-manager-699da83c0e9d22726e667344227e096b
</code></pre></div><ul>
<li>&ldquo;Confirming migration&hellip;&rdquo;</li>
<li>No detachment</li>
<li>New engine and replicas</li>
</ul>
<h4 id="24-rollback-immediately-after-crash">2.4 Rollback immediately after crash</h4>
<p>The volume automatically detaches from the old node. Then, it reattaches to the old node.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kl delete --wait<span style="color:#f92672">=</span>false pod instance-manager-699da83c0e9d22726e667344227e096b <span style="color:#f92672">&amp;&amp;</span> sleep 0.5 <span style="color:#f92672">&amp;&amp;</span> k delete -f va-2.yaml
<span style="color:#75715e"># OR</span>
kl delete --wait<span style="color:#f92672">=</span>false pod instance-manager-699da83c0e9d22726e667344227e096b <span style="color:#f92672">&amp;&amp;</span> sleep <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> k delete -f va-2.yaml
</code></pre></div><ul>
<li>&ldquo;&hellip;selected to detach from <old>&rdquo;</li>
<li>&ldquo;Cancelling migration for detached volume&hellip;&rdquo;</li>
<li>MigrationFailed event</li>
<li>&ldquo;&hellip;selected to attach to <old>&rdquo;</li>
<li>Same engine and replicas</li>
</ul>
<h4 id="25-rollback-immediately-before-crash">2.5 Rollback immediately before crash</h4>
<p>Confirmation succeeds. Then, the volume detaches from and reattaches to the old node.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">k delete --wait<span style="color:#f92672">=</span>false -f va-2.yaml <span style="color:#f92672">&amp;&amp;</span> sleep 0.5 <span style="color:#f92672">&amp;&amp;</span> kl delete pod instance-manager-699da83c0e9d22726e667344227e096b
<span style="color:#75715e"># OR</span>
k delete --wait<span style="color:#f92672">=</span>false -f va-2.yaml <span style="color:#f92672">&amp;&amp;</span> sleep <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> kl delete pod instance-manager-699da83c0e9d22726e667344227e096b
</code></pre></div><ul>
<li>&ldquo;Rolling back migration&rdquo;</li>
<li>&ldquo;&hellip;selected to detach from <old>&rdquo;</li>
<li>&ldquo;&hellip;selected to attach to <old>&rdquo;</li>
<li>Same engine and replicas (rolled back)</li>
</ul>
<h3 id="3-single-replica-crash">3. Single replica crash</h3>
<p>Crash the replica on a node that is neither the old or migration node by cordoning the node and killing its
instance-manager pod.</p>
<h4 id="31-degraded-before-migration-and-confirmation">3.1 Degraded before migration and confirmation</h4>
<p>Migration starts while the volume is degraded. Confirmation succeeds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">k cordon eweber-v126-worker-9c1451b4-rw5hf
kl delete pod instance-manager-6852914a55e4566d3ddea43529df22e0
k delete -f va-1.yaml
</code></pre></div><ul>
<li>&ldquo;Confirming migration&rdquo;</li>
<li>No detachment</li>
<li>New engine and replicas</li>
</ul>
<h4 id="32-degraded-before-migration-and-rollback">3.2 Degraded before migration and rollback</h4>
<p>Migration starts while the volume is degraded. Rollback succeeds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">k cordon eweber-v126-worker-9c1451b4-rw5hf
kl delete pod instance-manager-6852914a55e4566d3ddea43529df22e0

k apply -f va-1.yaml
k apply -f va-2.yaml
k delete -f va-2.yaml
</code></pre></div><ul>
<li>&ldquo;Rolling back migration&rdquo;</li>
<li>No detachment</li>
<li>Same engine and replicas</li>
</ul>
<h4 id="33-degraded-between-migration-start-and-confirmation">3.3 Degraded between migration start and confirmation</h4>
<p>Confirmation succeeds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">k apply -f va-1.yaml
k apply -f va-2.yaml

k cordon eweber-v126-worker-9c1451b4-rw5hf
kl delete pod instance-manager-6852914a55e4566d3ddea43529df22e0

k delete -f va-1.yaml
</code></pre></div><ul>
<li>&ldquo;Confirming migration&rdquo;</li>
<li>New engine and replicas</li>
</ul>
<h4 id="34-degraded-between-migration-start-and-rollback">3.4 Degraded between migration start and rollback</h4>
<p>Rollback succeeds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">k apply -f va-1.yaml
k apply -f va-2.yaml

k cordon eweber-v126-worker-9c1451b4-rw5hf
kl delete pod instance-manager-6852914a55e4566d3ddea43529df22e0

k delete -f va-2.yaml
</code></pre></div><ul>
<li>Rolling back migration</li>
<li>Same engine and replicas</li>
</ul>
<h3 id="4-attempt-to-attach-to-three-nodes">4. Attempt to attach to three nodes</h3>
<p>The third attachment fails.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kl apply -f va-1.yaml
kl apply -f va-2.yaml
kl apply -f va-3.yaml
</code></pre></div><ul>
<li>test-va-1 attached</li>
<li>test-va-2 attached</li>
<li>test-va-3 not attached</li>
<li>&ldquo;&hellip;cannot attach migratable volume to more than two nodes&hellip;&rdquo;</li>
</ul>
<h3 id="5-new-engine-node-down">5. New engine node down</h3>
<ol>
<li>Hard shut down the node running the migration engine.</li>
<li>Wait until Kubernetes recognizes the node is down. (This is IMPORTANT! Otherwise, it is a different test case.)</li>
<li>Attempt a confirmation or rollback.</li>
</ol>
<h4 id="51-confirmation">5.1 Confirmation</h4>
<p>The volume is allowed to detach from the old node (special logic in code). It attempts to attach to cleanly attach to
the migration node, but is stuck until it comes back.</p>
<ul>
<li>&ldquo;Waiting to confirm migration until migration engine is ready&rdquo;</li>
<li>&ldquo;Detaching volume for attempted migration to down node&rdquo;</li>
<li>&ldquo;&hellip;selected to attach to <new>&rdquo;</li>
<li>Same engine and replicas</li>
<li>Stuck in attaching waiting for node to come back</li>
</ul>
<pre tabindex="0"><code>kubectl -n longhorn-system get volume -oyaml | grep -i nodeid
    migrationNodeID: &quot;&quot;
    nodeID: eweber-v126-worker-9c1451b4-6464j
    currentMigrationNodeID: &quot;&quot;
    currentNodeID: &quot;&quot;
    pendingNodeID: &quot;&quot;
</code></pre><h4 id="52-rollback">5.2 Rollback</h4>
<p>Rollback succeeds.</p>
<ul>
<li>&ldquo;Rolling back migration&rdquo;</li>
<li>No detachment</li>
<li>Same engine and replicas</li>
</ul>
<h3 id="6-old-engine-node-down">6. Old engine node down</h3>
<ol>
<li>Hard shut down the node running the old engine.</li>
<li>Wait until Kubernetes recognizes the node is down. (This is IMPORTANT! Otherwise, it is a different test case.)</li>
<li>Verify the volume is no longer attached and no longer migrating. It should remain in this state indefinitely until
a confirmation or rollback is attempted.</li>
<li>Attempt a confirmation or rollback.</li>
</ol>
<h4 id="61-confirmation">6.1 Confirmation</h4>
<p>The migration is stuck until the Kubernetes pod eviction controller decides to terminate the instance-manager pod that
was running on the old node. Then, Longhorn detaches the volume and cleanly reattaches it to the migration node.</p>
<ul>
<li>&ldquo;Waiting to confirm migration&hellip;&rdquo; (new engine crashes when old one does)</li>
<li>Eventually&hellip;</li>
<li>&ldquo;&hellip;selected to detach from <old>&rdquo;</li>
<li>&ldquo;Cancelling migration for detached volume&hellip;&rdquo;</li>
<li>&ldquo;&hellip;selected to attach to <new>&rdquo;</li>
<li>Same engine and replicas</li>
</ul>
<h4 id="62-rollback">6.2 Rollback</h4>
<p>The migration is stuck until the Kubernetes pod eviction controller decides to terminate the instance-manager pod that
was running on the old node. Then, Longhorn detaches the volume and attempts to cleanly reattach it to the old node, but
it is stuck until the node comes back.</p>
<ul>
<li>&ldquo;Rolling back migration&rdquo;</li>
<li>Stuck in attached with engine and one replica unknown</li>
<li>Eventually&hellip;</li>
<li>&ldquo;&hellip;selected to detach from <old>&rdquo;</li>
<li>&ldquo;&hellip;selected to attach to <old>&rdquo;</li>
<li>Stuck in attaching waiting for node to come back</li>
<li>Same engine and replicas</li>
</ul>

    </article>
  <a href="https://github.com/longhorn/longhorn-tests/edit/master/docs/content/manual/pre-release/ha/ha-volume-migration.md" target="_blank" title="Edit on Github" style="font-size:smaller;float:right;padding-right:3%">[Edit]</a>
  </div>

    
    
  </body>
</html>
